{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quản lý đơn hàng - Aroma Café</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'main/css/admin.css' %}">

    <style>
        /* --- 1. OVERLAY & POPUP (Sửa lỗi hiển thị) --- */
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1999; display: none;
        }

        .detail-p {
            left: 50% !important; /* Căn giữa màn hình */
            transform: translate(-50%, -50%) !important;
            z-index: 2000 !important;
            width: 60%; max-width: 800px; max-height: 90vh;
            overflow-y: auto; display: none; padding: 25px !important;
        }

        .detail-p #close {
            font-size: 24px !important; top: 15px !important; right: 15px !important; color: #666 !important;
        }
        .detail-p #close:hover { color: red !important; }

        /* --- 2. THANH CÔNG CỤ (Đã đổi vị trí Trái/Phải) --- */
        .toolbar-container {
            background: #fff; padding: 20px 30px; margin: 0 30px 20px 30px;
            border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .filter-form {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Đẩy 2 phần sang 2 bên */
            gap: 20px; flex-wrap: wrap;
        }

        /* Nhóm 1: Lọc ngày (Giờ nằm bên TRÁI) */
        .date-group { 
            display: flex; align-items: center; gap: 10px; 
            flex: 1; /* Chiếm không gian cần thiết */
        }
        .date-group label { font-weight: 600; font-size: 14px; white-space: nowrap; }
        .date-group input[type="date"] { 
            height: 38px; padding: 0 10px; border: 1px solid #ddd; border-radius: 4px; 
        }
        .date-group .btn-filter { 
            height: 38px; padding: 0 20px; background: #c76739; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-weight: bold; white-space: nowrap;
        }
        .date-group .btn-filter:hover { background: #8c4828; }
        .date-group .btn-reset { text-decoration: none; color: #666; font-size: 14px; margin-left: 5px; white-space: nowrap; }

        /* Nhóm 2: Tìm kiếm (Giờ nằm bên PHẢI) */
        .search-group { 
            display: flex; 
            width: 40%; /* Giới hạn chiều rộng để đẹp hơn */
            min-width: 300px;
            justify-content: flex-end; /* Căn nội dung sang phải */
        }
        .search-group input { 
            width: 100%; height: 40px; padding: 0 15px; border: 1px solid #ddd; 
            border-right: none; border-radius: 4px 0 0 4px; outline: none; 
        }
        .search-group .btn-search { 
            height: 40px; padding: 0 20px; background: #f8f9fa; border: 1px solid #ddd; 
            border-left: none; border-radius: 0 4px 4px 0; cursor: pointer; color: #c76739; 
        }

        /* --- 3. CSS Chi tiết trong Popup --- */
        .order-table-scroll { max-height: 250px; overflow-y: auto; border: 1px solid #eee; margin-bottom: 20px; }
        .order-table-scroll table { margin: 0; width: 100%; }
        .order-table-scroll th { position: sticky; top: 0; background: #f1f1f1; z-index: 1; }

        .info-customer h4 { color: #c76739; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .info-row { display: flex; justify-content: space-between; gap: 20px; }
        .info-row .col { width: 48%; font-size: 14px; line-height: 1.6; }

        .totalSum { text-align: right; margin-top: 10px; padding-top: 10px; border-top: 2px solid #eee; }
        .totalSum h3 { color: #333; font-size: 20px; margin-top: 10px; }
        .totalSum h3 span { color: #c76739; font-weight: bold; }

        /* Nút Xuất Hóa Đơn - Sửa lỗi CSS */
        .btn-confirm {
            width: 100%; padding: 12px; margin-top: 15px;
            background: #c76739; color: white; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            font-size: 16px; transition: background 0.3s;
        }
        .btn-confirm:hover { background: #a04e28; }

        .detail-btn { width: 32px; height: 32px; background: #c76739; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .detail-btn:hover { background: #8c4828; }
        
        /* Phân trang */
        .pagination-custom { display: flex; justify-content: center; align-items: center; margin-top: 25px; gap: 10px; }
        .pagination-custom .current-page { background: #c76739; color: white; padding: 6px 15px; border-radius: 4px; font-weight: bold; }
        .pagination-custom .page-link { background: white; color: #333; padding: 6px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; }
    </style>
</head>
<body>

<div class="left-menu">
    <div class="logo">
        <img src="{% static 'main/img/logo.png' %}" onclick="location.href='{% url 'index' %}'">
    </div>
    <div class="menu">
        <a href="{% url 'adminPage1' %}" class="menu-item">Tổng quan</a>
        <a href="{% url 'adminPage2' %}" class="menu-item">Quản lí sản phẩm</a>
        <a href="{% url 'adminPage3' %}" class="menu-item active">Quản lí đơn hàng</a>
        <a href="{% url 'adminPage4' %}" class="menu-item">Quản lí tài khoản</a>
        <a href="{% url 'adminPage6' %}" class="menu-item">Quản lí đánh giá</a>
        <a href="{% url 'adminPage7' %}" class="menu-item">Quản lí banner</a>
        <a href="{% url 'adminPage8' %}" class="menu-item">Quản lí mã giảm giá</a>
        <a href="{% url 'adminPage5' %}" class="menu-item">Chăm sóc khách hàng</a>
        <a href="#" class="menu-item" onclick="location.href='{% url 'lougout' %}'">Đăng xuất</a>
    </div>
    <div class="footer">
        <p>2024 Aroma Café. All rights reserved.</p>
    </div>
</div>

<div class="right-content">
    <div class="title">
        <p>QUẢN LÝ ĐƠN HÀNG</p>
    </div>

    <div class="main-content">
        <div class="toolbar-container">
            <form method="GET" class="filter-form">
                <div class="date-group">
                    <label>Từ ngày:</label>
                    <input type="date" name="start_date" value="{{ start_date }}">
                    
                    <label>Đến:</label>
                    <input type="date" name="end_date" value="{{ end_date }}">
                    
                    <button type="submit" class="btn-filter">Lọc</button>
                    <a href="{% url 'adminPage3' %}" class="btn-reset">Đặt lại</a>
                </div>

                <div class="search-group">
                    <input type="text" name="q" placeholder="Nhập mã ĐH hoặc tên KH..." value="{{ search_query|default:'' }}">
                    <button type="submit" class="btn-search"><i class="fa fa-search"></i></button>
                </div>
            </form>
        </div>

        <div class="list-order">
            <h3>DANH SÁCH ĐƠN HÀNG</h3>
            
            <table>
                <thead>
                <tr>
                    <th>Xem</th>
                    <th>Mã ĐH</th>
                    <th>Khách hàng</th>
                    <th>Ngày đặt</th>
                    <th>Trạng thái</th>
                    <th>Tổng tiền</th>
                    <th>PTTT</th>
                </tr>
                </thead>
                <tbody>
                
                {% for order in orders %}
                <tr>
                    <td>
                        <button class="detail-btn" onclick="openPopup('popup-{{ order.id }}')">
                            <i class="fa-solid fa-list"></i>
                        </button>
                    </td>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.receiver_name }}</td> 
                    <td>{{ order.created_at|date:"d/m/Y" }}</td>
                    <td>
                        {% if order.status == 'Chờ xử lý' %}
                            <span class="status pending">{{ order.status }}</span>
                        {% elif order.status == 'Đang giao' %}
                            <span class="status shipping">{{ order.status }}</span>
                        {% elif order.status == 'Đã giao' %}
                            <span class="status completed">{{ order.status }}</span>
                        {% else %}
                            <span class="status cancelled">{{ order.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ order.final_amount|intcomma }}đ</td>
                    <td>{{ order.payment_method.name }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">Không tìm thấy đơn hàng nào.</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>

            <div class="pagination-custom">
                {% if orders.has_previous %}
                    <a href="?page={{ orders.previous_page_number }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">&laquo;</a>
                {% endif %}
                
                <span class="current-page">Trang {{ orders.number }} / {{ orders.paginator.num_pages }}</span>
                
                {% if orders.has_next %}
                    <a href="?page={{ orders.next_page_number }}&q={{ search_query }}&start_date={{ start_date }}&end_date={{ end_date }}" class="page-link">&raquo;</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="overlay" onclick="closeAllPopups()"></div>

{% for order in orders %}
<div class="detail-p" id="popup-{{ order.id }}">
    <button id="close" onclick="closePopup('popup-{{ order.id }}')"><i class="fas fa-times"></i></button>
    
    <h3>CHI TIẾT ĐƠN HÀNG #{{ order.id }}</h3>

    <div class="order-table-scroll">
        <table>
            <thead>
            <tr>
                <th>Tên sản phẩm</th>
                <th>Giá (VND)</th>
                <th>Số lượng</th>
            </tr>
            </thead>
            <tbody>
            {% for item in order.orderitems_set.all %}
            <tr>
                <td>{{ item.product.name }}</td>
                <td>{{ item.price|intcomma }}</td>
                <td>{{ item.quantity }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="info-customer">
        <h4>THÔNG TIN GIAO HÀNG</h4>
        <div class="info-row">
            <div class="col">
                <p><strong>Người nhận:</strong> {{ order.receiver_name }}</p>
                <p><strong>SĐT:</strong> {{ order.receiver_phone }}</p>
                <p><strong>Ngày đặt:</strong> {{ order.created_at|date:"d/m/Y H:i" }}</p>
            </div>
            <div class="col">
                {% with addr=order.orderaddresses_set.first %}
                    <p><strong>Tỉnh/TP:</strong> {{ addr.province }}</p>
                    <p><strong>Quận/Huyện:</strong> {{ addr.ward }}</p> 
                    <p><strong>Địa chỉ:</strong> {{ addr.address }}</p>
                {% endwith %}
            </div>
        </div>
    </div>

    <div class="totalSum">
        <p>Phí vận chuyển: <span>{{ order.shipping_fee|intcomma }} đ</span></p>
        <p>Giảm giá: <span>{{ order.discount_percent }}%</span></p>
        <h3>TỔNG TIỀN: <span>{{ order.final_amount|intcomma }} VND</span></h3>
    </div>

    {% if order.status == 'Chờ xử lý' or order.status == 'Pending' %}
    <form method="POST" action="" class="action-form">
        {% csrf_token %}
        <input type="hidden" name="order_id_hidden" value="{{ order.id }}">
        
        <button type="submit"
                name="btn_export_invoice" 
                class="btn-confirm">
            XUẤT HÓA ĐƠN
        </button>
    </form>
    {% endif %}
</div>
{% endfor %}

<script>
    function openPopup(id) {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById(id).style.display = 'block';
    }

    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function closeAllPopups() {
        document.querySelectorAll('.detail-p').forEach(p => p.style.display = 'none');
        document.getElementById('overlay').style.display = 'none';
    }
</script>
<script src="{% static 'main/js/admin.js' %}"></script>
</body>
</html>