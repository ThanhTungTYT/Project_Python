{% load static %}
{% load custom_filters %} <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'main/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'main/css/payment.css' %}">
    <style>
        /* CSS cho thông báo lỗi */
        .messages-box { margin: 20px auto; max-width: 1200px; padding: 0 20px; }
        .alert { padding: 15px; border-radius: 4px; margin-bottom: 10px; font-weight: 500; }
        .alert.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
    </style>
</head>
<body>
<header>
    <div class="top">
        <div class="logo">
            <img src="{% static 'main/img/logo.png' %}" onclick="location.href='{% url 'index' %}'" width="300px" height="100px" style="cursor: pointer;">
        </div>
        <form class="search-bar" action="{% url 'search' %}" method="get">
            <input type="text" id="search-input" placeholder="Tìm kiếm..." value="{{ request.GET.q|default:'' }}" name="q">
            <button id="search-button"><i class="fas fa-search"></i></button>
        </form>
        <div class="mini-menu">
            <div class="cart">
                <a href="{% url 'cart' %}"><i class="fas fa-shopping-cart"></i></a>
                <span id="num-cart-label">{{ cart_count|default:"0" }}</span>
            </div>
             {% if request.session.user_id %}
                {% if request.session.role == 'admin' %}
                    <a href="{% url 'adminPage1' %}"><i class="fa-solid fa-user"></i></a>
                {% else %}
                    <a href="{% url 'account' %}"><i class="fa-solid fa-user"></i></a>
                {% endif %}
            {% else %}
                <a href="{% url 'login' %}"><i class="fa-solid fa-user"></i></a>
            {% endif %}
        </div>
    </div>
    <div class="bottom">
        <a href="{% url 'index' %}">Trang chủ</a>
        <a href="{% url 'catalog' %}">Sản phẩm</a>
        <a href="{% url 'help' %}">Liên hệ</a>
        <a href="{% url 'aboutUs' %}">Giới thiệu</a>
    </div>
</header>

{% if messages %}
    <div class="messages-box">
        {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="checkout-container">
    
    <div class="back-link">
        <a href="{% url 'cart' %}"><i class="fas fa-arrow-left"></i> Quay lại giỏ hàng</a>
    </div>

    <div class="checkout-left">
        <section class="account-box">
            <h3>Tài khoản</h3>
            <div class="account-info">
                <div class="avatar-icon" id="account-btn">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <p class="name">{{ request.session.user_name|default:"Khách lẻ" }}</p>
                </div>
            </div>
        </section>

        <section class="shipping-box">
            <h3>Thông tin giao hàng</h3>
            
            <form class="shipping-form" id="shipping-form" method="POST" action="{% url 'process_checkout' %}">
                {% csrf_token %}
                
                <input type="text" name="fullname" id="fullname" class="save-input" placeholder="Họ và tên" required>
                
                <input type="text" name="phone" id="phone" class="save-input" placeholder="Số điện thoại" required>
                
                <input type="text" name="country" id="country" class="save-input" placeholder="Quốc gia" value="Vietnam" required>
                
                <input type="text" name="province" id="province" class="save-input" placeholder="Tỉnh/TP" required>
                
                <input type="text" name="ward" id="ward" class="save-input" placeholder="Quận/Huyện, Phường/Xã" required>
                
                <input type="text" name="address" id="address" class="save-input" placeholder="Đường, Số nhà" required>
                
                <div class="payment-method" style="margin-top: 20px;">
                    <h3>Phương thức thanh toán</h3>
                    <div class="radio-item">
                        <input type="radio" name="payment_method" value="cod" checked>
                        <p>Thanh toán khi nhận hàng (COD)</p>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="payment_method" value="bank">
                        <p>Chuyển khoản ngân hàng</p>
                    </div>
                </div>

                <div class="note-box" style="margin-top: 20px;">
                    <h3>Ghi chú</h3>
                    <textarea name="note" id="note" class="save-input" placeholder="Nhập ghi chú cho đơn hàng (nếu có)"></textarea>
                </div>
            </form>
        </section>
    </div>

    <div class="checkout-right">
        <section class="cart-box">
            <h3>Giỏ hàng</h3>
            <div id="cart-list">
                {% for item in items %}
                <div class="cart-item">
                     {% with image_object=item.product.productimages_set.first %}
                        {% if image_object %}
                            {% if "http" in image_object.image_url %}
                                <img src="{{ image_object.image_url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <img src="/static/main/img/{{ image_object.image_url }}" alt="{{ item.product.name }}">
                            {% endif %}
                        {% else %}
                            <img src="{% static 'main/img/no-image.png' %}" alt="No Image">
                        {% endif %}
                    {% endwith %}
                    <div class="cart-info">
                        <p class="product-name">{{ item.product.name }}</p>
                        <p class="product-type">Loại: {{ item.product.category.name }}</p>
                        <p class="weight">Khối lượng: {{ item.product.weight_grams}}g</p>
                        
                        <p class="price">{{ item.subtotal|vn_currency }}đ</p>
                    </div>
                    <div class="quantity-box">
                        <p style="font-size: 14px;">Số lượng: {{ item.quantity }}</p>
                    </div>
                </div>
                {% empty %}
                <p>Không có sản phẩm nào.</p>
                {% endfor %}
            </div>
        </section>

        <section class="discount-box">
            <h3>Mã khuyến mãi</h3>
            <form action="{% url 'apply_coupon' %}" method="POST" id="coupon-form">
                {% csrf_token %}
                <select onchange="document.getElementById('discount-code').value = this.value">
                    <option value="">-- Chọn mã có sẵn --</option>
                    {% for c in coupons %}
                    <option value="{{ c.code }}">{{ c.code }} - Giảm {{ c.discount_percent|vn_currency }}%</option>
                    {% endfor %}
                </select>
                <div class="apply-row">
                    <input type="text" name="coupon_code" id="discount-code" value="{{ coupon_code }}" placeholder="Nhập mã...">
                    <button class="apply-btn" type="submit">Áp dụng</button>
                </div>
            </form>
            {% if coupon_code %}
                <div style="margin-top: 10px;">
                    <span style="color: green;">Đang dùng mã: <strong>{{ coupon_code }}</strong></span>
                    <a href="{% url 'remove_coupon' %}" style="color: red; margin-left: 10px; font-size: 0.9rem; text-decoration: underline;">[Gỡ bỏ]</a>
                </div>
            {% endif %}
        </section>

        <section class="summary-box">
            <h3>Tóm tắt đơn hàng</h3>
            
            <div class="summary-row">
                <span>Tổng tiền hàng</span>
                <span id="total-price">{{ total_amount|vn_currency }}đ</span>
            </div>

            {% if discount_amount > 0 %}
            <div class="summary-row" style="color: green;">
                <span>Giảm giá ({{ discount_percent|vn_currency }}%):</span>
                <span>-{{ discount_amount|vn_currency }}đ</span>
            </div>
            {% endif %}

            <div class="summary-row">
                <span>Phí vận chuyển</span>
                <span>Miễn phí</span>
            </div>
            
            <div class="summary-row total">
                <span>Tổng thanh toán: </span>
                <span id="final-total" style="color: #d3b673; font-size: 1.2rem;">
                    {{ final_total|vn_currency }}đ
                </span>
            </div>
            
            <button class="checkout-btn" type="submit" form="shipping-form" onclick="clearFormData()">Đặt hàng</button>
        </section>
    </div>
</div>

<footer class="footer">
    <div class="footer-bottom">
        <p>&copy; 2024 Aroma Café. All rights reserved.</p>
    </div>
</footer>

<script src="{% static 'main/js/script.js' %}"></script>

<script>
    const inputs = document.querySelectorAll('.save-input');
    
    inputs.forEach(input => {
        const savedValue = sessionStorage.getItem(input.id);
        if (savedValue) {
            input.value = savedValue;
        }

        input.addEventListener('input', function() {
            sessionStorage.setItem(this.id, this.value);
        });
    });

    function clearFormData() {

        sessionStorage.clear();
    }
</script>

</body>
</html>